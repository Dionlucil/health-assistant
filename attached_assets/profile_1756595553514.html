{% extends "base.html" %}

{% block title %}Profile - Community Health Assistant{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="text-center mb-4">
                <div class="profile-avatar mb-3">
                    <i class="fas fa-user-circle fa-5x text-primary"></i>
                </div>
                <h2 class="fw-bold text-dark">Profile Settings</h2>
                <p class="text-muted">Manage your personal information and account settings</p>
            </div>

            <!-- Profile Form -->
            <div class="card shadow-lg border-0">
                <div class="card-body p-5">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <!-- Personal Information Section -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3">
                                <i class="fas fa-user me-2 text-primary"></i>Personal Information
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.first_name.label(class="form-label fw-semibold") }}
                                    {{ form.first_name(class="form-control", placeholder="Enter your first name") }}
                                    {% if form.first_name.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.first_name.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    {{ form.last_name.label(class="form-label fw-semibold") }}
                                    {{ form.last_name(class="form-control", placeholder="Enter your last name") }}
                                    {% if form.last_name.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.last_name.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mb-3">
                                {{ form.email.label(class="form-label fw-semibold") }}
                                {{ form.email(class="form-control", placeholder="Enter your email address") }}
                                {% if form.email.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.email.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    This email will be used for login and important notifications.
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Health Information Section -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3">
                                <i class="fas fa-heartbeat me-2 text-primary"></i>Health Information
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.date_of_birth.label(class="form-label fw-semibold") }}
                                    {{ form.date_of_birth(class="form-control") }}
                                    {% if form.date_of_birth.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.date_of_birth.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">
                                        <i class="fas fa-calendar me-1"></i>
                                        Age: 
                                        {% if current_user.date_of_birth %}
                                            {{ moment().diff(current_user.date_of_birth, 'years') }} years old
                                        {% else %}
                                            Not specified
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    {{ form.gender.label(class="form-label fw-semibold") }}
                                    {{ form.gender(class="form-select") }}
                                    {% if form.gender.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.gender.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Account Statistics Section -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3">
                                <i class="fas fa-chart-line me-2 text-primary"></i>Account Statistics
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="stat-card bg-light rounded p-3 text-center">
                                        <i class="fas fa-calendar-check fa-2x text-primary mb-2"></i>
                                        <h4 class="fw-bold mb-1">{{ current_user.consultations|length }}</h4>
                                        <p class="text-muted mb-0 small">Total Consultations</p>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="stat-card bg-light rounded p-3 text-center">
                                        <i class="fas fa-user-clock fa-2x text-success mb-2"></i>
                                        <h4 class="fw-bold mb-1">
                                            {{ moment(current_user.created_at).fromNow() }}
                                        </h4>
                                        <p class="text-muted mb-0 small">Member Since</p>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="stat-card bg-light rounded p-3 text-center">
                                        <i class="fas fa-sign-in-alt fa-2x text-info mb-2"></i>
                                        <h4 class="fw-bold mb-1">
                                            {% if current_user.last_login %}
                                                {{ moment(current_user.last_login).format('MMM DD') }}
                                            {% else %}
                                                Today
                                            {% endif %}
                                        </h4>
                                        <p class="text-muted mb-0 small">Last Login</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                            <div class="d-grid gap-2 d-md-flex">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </a>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex">
                                <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                    <i class="fas fa-key me-2"></i>Change Password
                                </button>
                                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                                    <i class="fas fa-trash me-2"></i>Delete Account
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Privacy Notice -->
            <div class="mt-4">
                <div class="card bg-light border-0">
                    <div class="card-body p-4">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-shield-alt me-2 text-success"></i>Privacy & Security
                        </h6>
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                Your personal information is encrypted and securely stored
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                We never share your health data with third parties
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                You can export or delete your data at any time
                            </li>
                            <li class="mb-0">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                All communications are protected with industry-standard security
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changePasswordModalLabel">
                    <i class="fas fa-key me-2"></i>Change Password
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" required>
                        <div class="form-text">Password must be at least 6 characters long.</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="changePassword()">
                    <i class="fas fa-save me-2"></i>Update Password
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteAccountModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Delete Account
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <h6 class="alert-heading">Warning: This action cannot be undone!</h6>
                    <p class="mb-0">Deleting your account will permanently remove all your data, including consultation history and personal information.</p>
                </div>
                
                <p>If you're sure you want to delete your account, please type <strong>DELETE</strong> in the box below:</p>
                
                <form id="deleteAccountForm">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="deleteConfirmation" placeholder="Type DELETE to confirm">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled onclick="deleteAccount()">
                    <i class="fas fa-trash me-2"></i>Delete My Account
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Password change functionality
function changePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        alert('New passwords do not match!');
        return;
    }
    
    if (newPassword.length < 6) {
        alert('Password must be at least 6 characters long!');
        return;
    }
    
    // Here you would typically send an AJAX request to change the password
    alert('Password change functionality would be implemented here.');
    
    // Close modal on success
    const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
    modal.hide();
}

// Delete account confirmation
document.getElementById('deleteConfirmation').addEventListener('input', function() {
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    if (this.value === 'DELETE') {
        confirmBtn.disabled = false;
    } else {
        confirmBtn.disabled = true;
    }
});

function deleteAccount() {
    // Here you would typically send an AJAX request to delete the account
    alert('Account deletion functionality would be implemented here.');
}

// Calculate and display age dynamically
document.getElementById('date_of_birth').addEventListener('change', function() {
    const birthDate = new Date(this.value);
    const today = new Date();
    const age = Math.floor((today - birthDate) / (365.25 * 24 * 60 * 60 * 1000));
    
    const ageDisplay = this.parentElement.querySelector('.form-text');
    if (ageDisplay) {
        ageDisplay.innerHTML = `<i class="fas fa-calendar me-1"></i>Age: ${age} years old`;
    }
});

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const firstNameInput = document.getElementById('first_name');
        const lastNameInput = document.getElementById('last_name');
        const emailInput = document.getElementById('email');
        
        if (firstNameInput.value.trim().length < 2) {
            e.preventDefault();
            alert('First name must be at least 2 characters long.');
            firstNameInput.focus();
            return;
        }
        
        if (lastNameInput.value.trim().length < 2) {
            e.preventDefault();
            alert('Last name must be at least 2 characters long.');
            lastNameInput.focus();
            return;
        }
        
        if (!emailInput.value.includes('@')) {
            e.preventDefault();
            alert('Please enter a valid email address.');
            emailInput.focus();
            return;
        }
    });
});
</script>
{% endblock %}
